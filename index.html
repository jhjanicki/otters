<!doctype html>
<html>
   <head>
      <meta charset="utf-8">
      <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <title>Otters trade map</title>
      <meta name="description" content="¿Activos energéticos 'varados'? Las plantas termoeléctricas de América Latina">
      <meta name="author" content="Julia Janicki">
      <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' type='text/css'>
      <link href="https://fonts.googleapis.com/css2?family=Enriqueta:wght@400;500;600;700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Work+Sans:300,400,500,700&display=swap" rel="stylesheet">
      <script src='https://api.mapbox.com/mapbox-gl-js/v1.6.0/mapbox-gl.js'></script>
      <link href='https://api.mapbox.com/mapbox-gl-js/v1.6.0/mapbox-gl.css' rel='stylesheet' />
      <link href="./style.css" rel="stylesheet">
      <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>
      <style></style>
   </head>
   <body>
      <div id='map'></div>
      <div id='logo'>
      </div>
      <div id='console'>
         <div class="verticalLine">
            <span id="toggleConsole">
            <img src="./img/toggle.png" />
            </span>
            <h1 id='title'>Otter Trade Map</h1>
            <div class="tab-slider--nav">
              <ul class="tab-slider--tabs">
                <li class="tab-slider--trigger activeTab text" rel="tab1">Species</li>
                <li class="tab-slider--trigger" rel="tab2">Use</li>
              </ul>
            </div>
            <div class="tab-slider--container">
              <div id="tab1" class="tab-slider--body">

                <div class="itemWrapper">
                  <svg id="reset2" class="item" version="1.1" x="0px" y="0px"
                    viewBox="0 0 48.9 42" style="enable-background:new 0 0 48.9 42;" xml:space="preserve">
                  <g id="">
                   <path id="XMLID_2_" class="st0" d="M13.2,32.2c-4.1-4.1-5.4-9.7-4.3-14.9l4.4,1.4L10.1,6L0.1,14.3l4.4,1.4
                     c-1.7,6.8,0.1,14.3,5.4,19.7c6.2,6.2,15.5,7.7,23.1,4.2L31.8,35C25.8,38.2,18.2,37.2,13.2,32.2z"/>
                   <path id="XMLID_1_" class="st0" d="M44.5,26c1.7-6.8-0.1-14.3-5.4-19.7c-6.2-6.2-15.4-7.6-23-4.3l1.1,4.6c6-3,13.6-2.1,18.5,2.9
                     c4.1,4.1,5.4,9.7,4.3,14.9l-4.4-1.4l3.1,12.7l10.1-8.4L44.5,26z"/>
                  </g>
                  </svg>
                  <div class="item">
                    <p> Reset Species</p>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle item filters' id="filter1">
                     <input id='Aonyx_cinereus_on' type="radio" value="Aonyx_cinereus_on" name="toggle" checked='checked'>
                     <input id='Aonyx_cinereus_off' type="radio" value="Aonyx_cinereus_off" name="toggle">
                     <div class="toggle__pointer color1"></div>
                  </div>
                  <div class="item">
                     <h2>Aonyx cinereus</h2>
                  </div>
                  <div class="item openProfile">
                    <svg version="1.1" id="open1"  x="0px" y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve">
                    <g>
                    	<path class="st0" d="M64,32h-8v20c0,2.2-1.8,4-4,4H12c-2.2,0-4-1.8-4-4V12c0-2.2,1.8-4,4-4h20V0H12C5.4,0,0,5.4,0,12v40
                    		c0,6.6,5.4,12,12,12h40c6.6,0,12-5.4,12-12V32z"/>
                    	<path class="st0" d="M64,4c0-2.2-1.8-4-4-4H40v8h10.3l-24,24l5.7,5.7l24-24V24h8V4z"/>
                    </g>
                    </svg>
                  </div>
                  <div class="item addRange">
                    <svg version="1.1" id="add1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                    	 viewBox="0 0 20.6 16" style="enable-background:new 0 0 20.6 16;" xml:space="preserve">
                    </svg>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle2 item filters' id="filter2">
                     <input id='Lutra_lutra_on' type="radio" value="Lutra_lutra_on" name="toggle2" checked='checked'>
                     <input id='Lutra_lutra_off' type="radio" value="Lutra_lutra_off" name="toggle2">
                     <div class="toggle__pointer color2"></div>
                  </div>
                  <div class="item">
                     <h2 id="fourteen">Lutra lutra</h2>
                  </div>
                  <div class="item openProfile">
                    <svg version="1.1" id="open2"  x="0px" y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve">
                    <g>
                    	<path class="st0" d="M64,32h-8v20c0,2.2-1.8,4-4,4H12c-2.2,0-4-1.8-4-4V12c0-2.2,1.8-4,4-4h20V0H12C5.4,0,0,5.4,0,12v40
                    		c0,6.6,5.4,12,12,12h40c6.6,0,12-5.4,12-12V32z"/>
                    	<path class="st0" d="M64,4c0-2.2-1.8-4-4-4H40v8h10.3l-24,24l5.7,5.7l24-24V24h8V4z"/>
                    </g>
                    </svg>
                  </div>
                  <div class="item addRange">
                    <svg version="1.1" id="add2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                    	 viewBox="0 0 20.6 16" style="enable-background:new 0 0 20.6 16;" xml:space="preserve">
                    </svg>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle3 item filters' id="filter3">
                     <input id='Lutra_sumatrana_on' type="radio" value="Lutra_sumatrana_on" name="toggle3" checked='checked'>
                     <input id='Lutra_sumatrana_off' type="radio" value="Lutra_sumatrana_off" name="toggle3">
                     <div class="toggle__pointer color3"></div>
                  </div>
                  <div class="item">
                     <h2 id="ten">Lutra sumatrana</h2>
                  </div>
                  <div class="item openProfile">
                    <svg version="1.1" id="open3"  x="0px" y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve">
                    <g>
                    	<path class="st0" d="M64,32h-8v20c0,2.2-1.8,4-4,4H12c-2.2,0-4-1.8-4-4V12c0-2.2,1.8-4,4-4h20V0H12C5.4,0,0,5.4,0,12v40
                    		c0,6.6,5.4,12,12,12h40c6.6,0,12-5.4,12-12V32z"/>
                    	<path class="st0" d="M64,4c0-2.2-1.8-4-4-4H40v8h10.3l-24,24l5.7,5.7l24-24V24h8V4z"/>
                    </g>
                    </svg>
                  </div>
                  <div class="item addRange">
                    <svg version="1.1" id="add3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                    	 viewBox="0 0 20.6 16" style="enable-background:new 0 0 20.6 16;" xml:space="preserve">
                    </svg>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle4 item filters' id="filter4">
                     <input id='Lutrogale_perspicillata_on' type="radio" value="Lutrogale_perspicillata_on" name="toggle4" checked='checked'>
                     <input id='Lutrogale_perspicillata_off' type="radio" value="Lutrogale_perspicillata_off" name="toggle4">
                     <div class="toggle__pointer color4"></div>
                  </div>
                  <div class="item">
                     <h2 id="thirteen">Lutrogale perspicillata</h2>
                  </div>
                  <div class="item openProfile">
                    <svg version="1.1" id="open4"  x="0px" y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve">
                    <g>
                    	<path class="st0" d="M64,32h-8v20c0,2.2-1.8,4-4,4H12c-2.2,0-4-1.8-4-4V12c0-2.2,1.8-4,4-4h20V0H12C5.4,0,0,5.4,0,12v40
                    		c0,6.6,5.4,12,12,12h40c6.6,0,12-5.4,12-12V32z"/>
                    	<path class="st0" d="M64,4c0-2.2-1.8-4-4-4H40v8h10.3l-24,24l5.7,5.7l24-24V24h8V4z"/>
                    </g>
                    </svg>
                  </div>
                  <div class="item addRange">
                    <svg version="1.1" id="add4" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                    	 viewBox="0 0 20.6 16" style="enable-background:new 0 0 20.6 16;" xml:space="preserve">
                    </svg>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle5 item filters' id="filter5">
                     <input id='Multiple_on' type="radio" value="Multiple_on" name="toggle5" checked='checked'>
                     <input id='Multiple_off' type="radio" value="Multiple_off" name="toggle5">
                     <div class="toggle__pointer color5"></div>
                  </div>
                  <div class="item">
                     <h2 id="eleven">Multiple</h2>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle6 item filters' id="filter6">
                     <input id='Unsure_on' type="radio" value="Unsure_on" name="toggle6" checked='checked'>
                     <input id='Unsure_off' type="radio" value="Unsure_off" name="toggle6">
                     <div class="toggle__pointer color6"></div>
                  </div>
                  <div class="item">
                     <h2 id="twelve">Unsure</h2>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle7 item filters' id="filter7">
                     <input id='Not_identified_on' type="radio" value="Not_identified_on" name="toggle7" checked='checked'>
                     <input id='Not_identified_off' type="radio" value="Not_identified_off" name="toggle7">
                     <div class="toggle__pointer color7"></div>
                  </div>
                  <div class="item">
                     <h2 id="fifteen">Not identified</h2>
                  </div>
                </div>
              </div>
              <!-- end tab 1 -->
              <div id="tab2" class="tab-slider--body">

                <div class="itemWrapper">
                  <svg id="reset" class="item" version="1.1" x="0px" y="0px"
                    viewBox="0 0 48.9 42" style="enable-background:new 0 0 48.9 42;" xml:space="preserve">
                  <g id="">
                   <path id="XMLID_2_" class="st0" d="M13.2,32.2c-4.1-4.1-5.4-9.7-4.3-14.9l4.4,1.4L10.1,6L0.1,14.3l4.4,1.4
                     c-1.7,6.8,0.1,14.3,5.4,19.7c6.2,6.2,15.5,7.7,23.1,4.2L31.8,35C25.8,38.2,18.2,37.2,13.2,32.2z"/>
                   <path id="XMLID_1_" class="st0" d="M44.5,26c1.7-6.8-0.1-14.3-5.4-19.7c-6.2-6.2-15.4-7.6-23-4.3l1.1,4.6c6-3,13.6-2.1,18.5,2.9
                     c4.1,4.1,5.4,9.7,4.3,14.9l-4.4-1.4l3.1,12.7l10.1-8.4L44.5,26z"/>
                  </g>
                  </svg>
                  <div class="item">
                    <p> Reset Use</p>
                  </div>
                </div>

                <div class="itemWrapper">
                  <div class='row toggle8 item filters' id="filter8">
                     <input id='Skin_on' type="radio" value="Skin_on" name="toggle8" checked='checked'>
                     <input id='Skin_off' type="radio" value="Skin_off" name="toggle8">
                     <div class="toggle__pointer color1"></div>
                  </div>
                  <div class="item">
                     <h2 id="three">Skin</h2>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle9 item filters' id="filter9">
                     <input id='Tail_on' type="radio" value="Tail_on" name="toggle9" checked='checked'>
                     <input id='Tail_off' type="radio" value="Tail_off" name="toggle9">
                     <div class="toggle__pointer color2"></div>
                  </div>
                  <div class="item">
                     <h2 id="one">Tail</h2>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle10 item filters' id="filter10">
                     <input id='Pet_on' type="radio" value="Pet_on" name="toggle10" checked='checked'>
                     <input id='Pet_off' type="radio" value="Pet_off" name="toggle10">
                     <div class="toggle__pointer color3"></div>
                  </div>
                  <div class="item">
                     <h2 id="five">Pet</h2>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle11 item filters' id="filter11">
                     <input id='Piece_on' type="radio" value="Piece_on" name="toggle11" checked='checked'>
                     <input id='Piece_off' type="radio" value="Piece_off" name="toggle11">
                     <div class="toggle__pointer color4"></div>
                  </div>
                  <div class="item">
                     <h2 id="four">Piece</h2>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle12 item filters' id="filter12">
                     <input id='Carcass_on' type="radio" value="Carcass_on" name="toggle12" checked='checked'>
                     <input id='Carcass_off' type="radio" value="Carcass_off" name="toggle12">
                     <div class="toggle__pointer color5"></div>
                  </div>
                  <div class="item">
                     <h2 id="seven">Carcass</h2>
                  </div>
                </div>
                <div class="itemWrapper">
                  <div class='row toggle13 item filters' id="filter13">
                     <input id='Unknown_on' type="radio" value="Unknown_on" name="toggle13" checked='checked'>
                     <input id='Unknown_off' type="radio" value="Unknown_off" name="toggle13">
                     <div class="toggle__pointer color6"></div>
                  </div>
                  <div class="item">
                     <h2>Unknown</h2>
                  </div>
                </div>

                <div class="itemWrapper">
                  <div class='row toggle14 item filters' id="filter14">
                     <input id='Multiple2_on' type="radio" value="Multiple2_on" name="toggle14" checked='checked'>
                     <input id='Multiple2_off' type="radio" value="Multiple2_off" name="toggle14">
                     <div class="toggle__pointer color7"></div>
                  </div>
                  <div class="item">
                     <h2>Multiple</h2>
                  </div>
                </div>
              </div>

              <div id="yearSelection" class='row itemWrapper'>
                 <div class="item yearToggle2">
                    <h2 id="">Cumulative</h2>
                 </div>
                 <div class='row toggle15 item yearToggle' id="filterYear">
                    <input id='cumulative_on' type="radio" value="cumulative_on" name="toggle15" checked='checked'>
                    <input id='cumulative_off' type="radio" value="cumulative_off" name="toggle15">
                    <div class="toggle__pointer color8"></div>
                 </div>
                 <div class="item yearToggle2">
                    <h2 id="">By Year</h2>
                 </div>
               </div>
              </div>
              <div class='session' id='sliderbar'>
                 <input id='slider' class='row' type='range' min='0' max='' step='1' value='' />
                 <div id="wrapper">
                    <p id="start"></p>
                    <p id="end"></p>
                 </div>
              </div>
              <div id="playpause" class="itemWrapper">
                <div id="play" class="item">
                    <img src="img/play.png" />
                </div>
                <div id="stop" class="item">
                    <img src="img/pause.png" />
                </div>
                <p id="yearDisplay"class="item">Year: <span id="selectedYear">2019</span></p>
             </div>
            </div>
            <!-- <div id="traded" class='row itemWrapper'>
               <h2 class="subtitle"> Number Traded </h2>
            </div>
            <div class='row itemWrapper'>
               <div id="circleSizes">
                  <img id="minCircle" class='item2' src="./img/legend.svg" /img>
                  <p id="minCircleVal" class='item2'></p>
                  <img id="maxCircle" class='item2' src="./img/legend.svg" /img>
                  <p id="maxCircleVal" class='item2'></p>
               </div>
            </div> -->

         </div>
         <!-- end line -->
      </div>
      <div id="profile">
          <svg version="1.1" id="close" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
             viewBox="0 0 14 14" style="enable-background:new 0 0 14 14;" xml:space="preserve">
          <path d="M7,5.6l5.3-5.3c0.4-0.4,1-0.4,1.4,0c0.4,0.4,0.4,1,0,1.4l-12,12c-0.4,0.4-1,0.4-1.4,0c-0.4-0.4-0.4-1,0-1.4c0,0,0,0,0,0
            L5.6,7L0.3,1.7c-0.4-0.4-0.4-1,0-1.4c0.4-0.4,1-0.4,1.4,0L7,5.6z M8.8,10.2c-0.4-0.4-0.4-1,0-1.4c0.4-0.4,1-0.4,1.4,0l3.5,3.5
            c0.4,0.4,0.4,1,0,1.4c-0.4,0.4-1,0.4-1.4,0C12.3,13.7,8.8,10.2,8.8,10.2z"/>
          </svg>
        <h4 id="profileSpp"> Otter profiles </h4>
        <p id="profileSpp2"> Common name </p>
        <img id="profileImg" src="" />
        <p id="profileStatus"> IUCN Status </p>
      </div>

      <div id="chart">
        <div class="itemWrapper2">
          <svg id="reset3" class="item4" version="1.1" x="0px" y="0px"
            viewBox="0 0 48.9 42" style="enable-background:new 0 0 48.9 42;" xml:space="preserve">
          <g id="">
           <path id="XMLID_2_" class="st0" d="M13.2,32.2c-4.1-4.1-5.4-9.7-4.3-14.9l4.4,1.4L10.1,6L0.1,14.3l4.4,1.4
             c-1.7,6.8,0.1,14.3,5.4,19.7c6.2,6.2,15.5,7.7,23.1,4.2L31.8,35C25.8,38.2,18.2,37.2,13.2,32.2z"/>
           <path id="XMLID_1_" class="st0" d="M44.5,26c1.7-6.8-0.1-14.3-5.4-19.7c-6.2-6.2-15.4-7.6-23-4.3l1.1,4.6c6-3,13.6-2.1,18.5,2.9
             c4.1,4.1,5.4,9.7,4.3,14.9l-4.4-1.4l3.1,12.7l10.1-8.4L44.5,26z"/>
          </g>
          </svg>
          <div class="item4">
            <p> Reset year to cumulative 2019</p>
          </div>
          <div class="item4" id="clickInstruction">
            <p> Click on bar to select a year</p>
          </div>
        </div>
      </div>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
      <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.14.2/d3.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
      <script src='./textures.min.js'></script>
      <script src='./profilesData.js'></script>

      <script>

      //******************
      // Responsive setup
      //******************

      var windowWidth = $(window).width();
      var windowHeight = $(window).height();
      var viewportWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      var viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

      var mobile = false;
      var medium = false;
      var iphone = false;
      var safari = false;

      $(window).resize(function() {
          if (windowWidth != $(window).width() || windowHeight != $(window).height()) {
              location.reload();
              return;
          }
      });


      if ( viewportWidth < 800 && viewportWidth >= 600) {
          medium = true;
      }

      if (/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || viewportWidth < 600) {
          mobile = true;
      }


      if (/iPhone/i.test(navigator.userAgent)) {
          iphone = true;
      } else {
          //console.log(/iPhone/i.test(navigator.userAgent))
      }

      //if Safari
      var ua = navigator.userAgent.toLowerCase();
      if (ua.indexOf('safari') != -1) {
          if (ua.indexOf('chrome') > -1) { // Chrome
          } else { // Safari
              safari = true;
          }
      }

      if (viewportWidth < 700) {
          $("#instruction").css("display", "none");
      } else {
          $("#instruction").css("display", "inherit");
      }

      var legendShow = false;

      //**********
      // Map setup
      //**********

      mapboxgl.accessToken = 'pk.eyJ1IjoiamhqYW5pY2tpIiwiYSI6Il9vb1ZlWnMifQ.zJie3Sr8zh3h5rR8IBMB2A';

      var map;
      var popup;

      // status
      var geoJsonData = {
          'type': 'FeatureCollection',
          'features': []
      };

      if (mobile) {

          map = new mapboxgl.Map({
              container: 'map', // container element id
              style: 'mapbox://styles/jhjanicki/ckkpmqel915iq17s1fkmhgyby',
              center: [78.217997,24.403233], // initial map center in [lon, lat]
              zoom: 2,
              minZoom: 2
          });

      } else {

          map = new mapboxgl.Map({
              container: 'map', // container element id
              style: 'mapbox://styles/jhjanicki/ckkpmqel915iq17s1fkmhgyby',
              center: [78.217997,24.403233], // initial map center in [lon, lat]
              zoom: 3,
              minZoom: 2
          });

      }


      function addLayer(layer1,layer2,layercolor,source){

        map.addSource(layer1, {
              type: 'geojson',
              data: source
            });

        map.addLayer({
           'id': layer1,
           'type': 'line',
           'source': layer1,
           'paint': {
           'line-color': layercolor,
           'line-opacity': 0,
           'line-width':1
           }
        });

        map.addLayer({
           'id': layer2,
           'type': 'fill',
           'source': layer1,
           'paint': {
           'fill-color': layercolor,
           'fill-opacity': 0
           }
        });
      }

      map.on('load', function() {

          init(); // test google sheet
          $("#toggleConsole").click(function() {
              $("#console").toggleClass("active");
              $("#toggleConsole img").toggleClass("flip");
          });

          // var consoleHeight = $("#console").height() / 2;
          $("#toggleConsole").css("top", 310);

          if(medium){
            $("#toggleConsole").css("top", 250);
          }

          if(mobile){
            $("#toggleConsole").css("top", 240);
          }

          addLayer('aonyx','aonyx2','#80BA5A','./data/aonyx.geojson');
          addLayer('lutra','lutra2','#008695','./data/lutra.geojson');
          addLayer('lutra3','lutra4','#3969AC','./data/lutra2.geojson');
          addLayer('lutrogale','lutrogale2','#F2B701','./data/lutrogale.geojson');


      });


      if (!mobile) {
          map.addControl(new mapboxgl.NavigationControl());
      }

      //*****************
      // Global variables
      //*****************

      var activeSpecies = ['Aonyx cinereus','Lutra lutra','Lutra sumatrana','Lutrogale perspicillata','Multiple','Unsure','Not identified']
      var activeUse = ['Skin','Tail','Pet','Piece','Carcass','Unknown','Many']

      var allSpecies = ['Aonyx cinereus','Lutra lutra','Lutra sumatrana','Lutrogale perspicillata','Multiple','Unsure','Not identified']
      var allUse = ['Skin','Tail','Pet','Piece','Carcass','Unknown','Many']

      var min = 10;
      var max = 10;
      var yearMin = 2000;
      var yearMax = 2000;
      var minCircleSize = 5;
      var maxCircleSize = 30;

      var tab1 = true;


      //**********
      // Read data
      //**********

      function init() {

            Tabletop.init({
                key: 'https://docs.google.com/spreadsheets/d/16Bv56VJDj4GWPYwyKzybwnThOUqLayZGS6jw_Z4UR-I/edit?usp=sharing',
                callback: onDataLoad,
                simpleSheet: true
            });

      }


      function onDataLoad(data, index) {

          $('#loading').hide();

          data.forEach(function(row) {

              // to deal with null lat lon values
               var lat;
               var lon;
               var sum;

               if(row.Longitude==null || row.Longitude=='' || row.Latitude==null || row.Latitude==''){
                 //console.log(row)
                 lon = null;
                 lat = null;
               }else{
                 lon = +row.Longitude;
                 lat = +row.Latitude;
               }

               // to deal with null lat lon values

              if(row.Sum =='' || row.Sum==null || row.Sum==''){

              }else{
                if (+row.Sum < min) {
                    min = +row.Sum;
                }
                if (+row.Sum > max) {
                    max = +row.Sum;
                }
              }

              if(row.Year =='' || row.Year==null || row.Year==''){

              }else{
                if (+row.Year < yearMin) {
                    yearMin = +row.Year;
                }
                if (+row.Year > yearMax) {
                    yearMax = +row.Year;
                }
              }

              if (isNaN(+row.Sum)) {
                 sum = null;
               }else{
                 sum = +row.Sum;
               }


              var feature = {
                  'type': 'Feature',
                  'properties': {
                      'id': 'id'+index,
                      'longitude': lon,
                      'latitude': lat,
                      'year': +row.Year,
                      'country': row.Seizure_Country,
                      'location': row.Seizure_Location,
                      'countryCentroidBool': +row.Country_centroid,
                      'dead': +row.Dead,
                      'live': +row.Live,
                      'sum': sum,
                      'species': row.Species,
                      'species1': row.Species1,
                      'speciesDetail': row.Species_Detail,
                      'use': row.Use,
                      'useDetail': row.use_Detail,
                      'source': row.Source,
                      'Lutra_lutra': +row.Lutra_lutra,
                      'Not_identified': +row.Not_identified,
                      'Unsure': +row.Unsure,
                      'Multiple': +row.Multiple,
                      'Aonyx_cinereus': +row.Aonyx_cinereus,
                      'Lutrogale_perspicillata': +row.Lutrogale_perspicillata,
                      'Skin': +row.Skin,
                      'Tail': +row.Tail,
                      'Pet': +row.Pet,
                      'Unknown': +row.Unknown,
                      'Piece': +row.Piece,
                      'Many': +row.Many,
                      'Carcass': +row.Carcass
                  },
                  'geometry': {
                      'type': 'Point',
                      'coordinates': [+row.Longitude,+row.Latitude],
                  }
              };


              if(lon != null && lat !=null && !isNaN(lon) && !isNaN(lat)){
                geoJsonData['features'].push(feature);
              }

          });

          //console.log(min)


          //*****************************
          // Map related global variables
          //*****************************

          var speciesFilter = ["in", ["get", "species"], ["literal", activeSpecies]];
          var useFilter = ["in", ["get", "use"], ["literal", activeUse]];
          var yearFilter = ["<=", ["get", "year"], yearMax];

          $("#minCircleVal").html(`${min}`);
          $("#maxCircleVal").html(`${max}`);

           $("#start").html(yearMin);
           $("#end").html(yearMax);

           $('#slider').prop('min', yearMin);
           $('#slider').prop('max', yearMax);
           $('#slider').prop('value', yearMax);

           var sliderValG = $("#slider").val();
           sliderValG = parseInt(sliderValG)

           var cumulative = true;
           var speciesMode = true;

          //*************
          // Draw circles
          //*************


          map.addLayer({
              id: 'otters',
              type: 'circle',
              source: {
                  type: 'geojson',
                  data: geoJsonData
              },
              paint: {
                "circle-color": [
                     "case",
                     ["==", ["get", "species"], 'Aonyx cinereus'],
                     "#80BA5A",
                     ["==", ["get", "species"], 'Lutra lutra'],
                     "#008695",
                     ["==", ["get", "species"], 'Lutra sumatrana'],
                     '#3969AC',
                     ["==", ["get", "species"], 'Lutrogale perspicillata'],
                      '#F2B701',
                     ["==", ["get", "species"], 'Multiple'],
                      '#CF1C90',
                     ["==", ["get", "species"], 'Unsure'],
                     "#A5AA99",
                     "#f97b72"
                   ],
                     'circle-radius': [
                       'interpolate',
                       ["linear"],
                       ['get', 'sum'],
                       min,
                       minCircleSize,
                       max,
                       maxCircleSize
                     ],
                     'circle-opacity': 0.7,
                     'circle-stroke-color':'#000',
                     'circle-stroke-width':0.5
              }
          });

          map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);


          //***********
          // SVG setup
          //***********

          var width = 800,
              height = 250,
              margin = {
                  top: 50,
                  right: 20,
                  bottom: 30,
                  left: 40
              };


          var svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height);


          //*****************************
          // Prepare data for stacked bar
          //*****************************

          var parser = d3.timeParse("%Y")

          data.forEach(function(d){
              d.Sum = +d.Sum;
              d.Year = +d.Year;
              d.Lutra_lutra = +d.Lutra_lutra;
              d.Not_identified = +d.Not_identified;
              d.Unsure = +d.Unsure;
              d.Multiple = +d.Multiple;
              d.Aonyx_cinereus = +d.Aonyx_cinereus;
              d.Lutrogale_perspicillata = +d.Lutrogale_perspicillata;
              d.Lutra_sumatrana = +d.Lutra_sumatrana;
              d.Skin=+d.Skin,
              d.Tail=+d.Tail,
              d.Pet=+d.Pet,
              d.Unknown=+d.Unknown,
              d.Piece=+d.Piece,
              d.Many=+d.Many,
              d.Carcass=+d.Carcass,
              d.Latitude = +d.Latitude;
              d.Longitude = +d.Longitude;
              d['date'] = parser(d.Year)
          })

          var dataGrouped = _.chain(data)
          .groupBy("Year")
          // `key` is group's name (color), `value` is the array of objects
          .map((value,key) => ({
            id: key, //year
            total: _.sumBy(value, "Sum"),
            array: value
           }))
          .value()

          data.sort(function(a,b) {
            return a.Year - b.Year;
          });


          //******************
          // Prepare D3 scales
          //******************


          var xScale = d3.scaleTime().domain([parser(1980),parser(2020)]).range([margin.left, width - margin.right]);
          //d3.extent(sppData, d => d.date)
          var yScale = d3.scaleLinear().domain([0,d3.max(data, d=>d.Sum)]).range([height - margin.bottom, margin.top])
          //d3.max(dataGrouped, d=>d.total)



          //**************
          // Setup D3 axes
          //**************

          var xAxis = svg.append("g").attr("class", "x-axis")
              .attr("transform", `translate(0, ${height-margin.bottom} )`)
              .call(d3.axisBottom(xScale))

          var yAxis = svg.append("g").attr("class", "y-axis")
              .attr("transform", `translate(${margin.left}, 0)`)
              .call(d3.axisLeft(yScale));


          //*********************************************************
          // function to draw rects. called by slider and filter year
          //*********************************************************

          function drawRects(year, cumul) {

            if(tab1){ // if spp tab

              if (cumul) {
                  d3.selectAll('rect').attr('fill', function(el) {
                      var texture = textures
                          .lines()
                          .size(4)
                          .strokeWidth(1.5)
                          .stroke(color(el.data.Species1));
                      svg.call(texture);
                      if (el.data.Year <= year) {
                          return texture.url()
                      } else {
                          return color(el.data.Species1)
                      }
                  });

              } else {

                  d3.selectAll('rect').attr('fill', el => color(el.data.Species1)); //reset all rect colors
                  d3.selectAll('rect').attr('fill', function(el) {
                      var texture = textures
                          .lines()
                          .size(4)
                          .strokeWidth(1.5)
                          .stroke(color(el.data.Species1));
                      svg.call(texture);
                      if (el.data.Year == year) {
                          return texture.url()
                      } else {
                          return color(el.data.Species1)
                      }
                  });
              }

            }else{ // if use tab

              if (cumul) {
                  d3.selectAll('rect').attr('fill', function(el) {
                      var texture = textures
                          .lines()
                          .size(4)
                          .strokeWidth(1.5)
                          .stroke(colorUse(el.data.Use));
                      svg.call(texture);
                      if (el.data.Year <= year) {
                          return texture.url()
                      } else {
                          return colorUse(el.data.Use)
                      }
                  });

              } else {

                  d3.selectAll('rect').attr('fill', el => colorUse(el.data.Use)); //reset all rect colors
                  d3.selectAll('rect').attr('fill', function(el) {
                      var texture = textures
                          .lines()
                          .size(4)
                          .strokeWidth(1.5)
                          .stroke(colorUse(el.data.Use));
                      svg.call(texture);
                      if (el.data.Year == year) {
                          return texture.url()
                      } else {
                          return colorUse(el.data.Use)
                      }
                  });
              }


            }

          }

          //*************
          // Timer setup
          //*************

           var myTimer;
            d3.select("#play").on("click", function() {

             clearInterval (myTimer);
              myTimer = setInterval (function() {
                  var b = d3.select("#slider");
                  var t = (+b.property("value") + 1) % (+b.property("max") + 1);
                  if (t == 0) { t = +b.property("min"); }
                  b.property("value", t);
                  $("#slider").val(t);
                  $("#slider").trigger('change');
                  sliderValG = t;

                  if(cumulative){
                     yearFilter =  ['<=', ['get','year'], t];
                     drawRects(t,true);

                  }else{
                    yearFilter = ["==", ["get", "year"], t];
                    d3.selectAll('rect').attr('fill',el=>color(el.data.Species1));//reset all rect colors
                    drawRects(t,false);

                  }
                  map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);
                  document.getElementById('selectedYear').innerText = t;
                }, 200);
            });

            d3.select("#stop").on("click", function() {
              clearInterval (myTimer);
            });

            //******************
            // Filter year setup
            //******************


           document.getElementById("filterYear").addEventListener('change', function(e) {
             if(e.target.value=="cumulative_on"){
               cumulative = true;
               //d3.select("#clickInstruction").style("opacity",1);
                yearFilter =  ['<=', ['get','year'], sliderValG];
                d3.selectAll('rect').attr('fill',el=>color(el.data.Species1));//reset all rect colors
                drawRects(sliderValG,true);

             }else{
               cumulative = false;
               //d3.select("#clickInstruction").style("opacity",0);
               yearFilter = ["==", ["get", "year"], sliderValG];
               d3.selectAll('rect').attr('fill',el=>color(el.data.Species1));//reset all rect colors
               drawRects(sliderValG,false);

             }
             map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);
           });


           //**************
           // Slider setup
           //**************

           document.getElementById('slider').addEventListener('input', function(e) {
                    d3.selectAll('rect').attr('fill',el=>color(el.data.Species1));
                    //reset all rect colors

                   var sliderVal = +e.target.value;
                   sliderValG = sliderVal;

                   //below is redundant in many parts, put in own function
                   if(cumulative){
                      yearFilter =  ['<=', ['get','year'], sliderVal];
                      drawRects(sliderValG,true);
                   }else{
                     yearFilter = ["==", ["get", "year"], sliderVal];
                     d3.selectAll('rect').attr('fill',el=>color(el.data.Species1));//reset all rect colors
                     drawRects(sliderValG,false);
                   }
                  document.getElementById('selectedYear').innerText = sliderVal;

                  map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);

           }); //end slider input


           //**************
           //grouped bar
           //**************

           // go over data, and group by year + use or year + spp and sum for that year

           // var nestedSpp = d3.nest()
           //    .key(function(d) {return d.Year;})
           //    .rollup(function(d) {
           //      //console.log(d)
           //      return {
           //          Species: d[0].Species1,
           //          Lutra_lutra: d3.sum(d, function(e) { return e.Lutra_lutra; }),
           //          Not_identified: d3.sum(d, function(e) { return e.Not_identified; }),
           //          Unsure: d3.sum(d, function(e) { return e.Unsure; }),
           //          Multiple: d3.sum(d, function(e) { return e.Multiple; }),
           //          Aonyx_cinereus: d3.sum(d, function(e) { return e.Aonyx_cinereus; }),
           //          Lutrogale_perspicillata: d3.sum(d, function(e) { return e.Lutrogale_perspicillata; }),
           //          Lutra_sumatrana: d3.sum(d, function(e) { return e.Lutra_sumatrana; })
           //      };
           //
           //    })
           //    .entries(data);
           //    console.log(nestedSpp)
           //
           //    var flatSpp = []
           //      nestedSpp.forEach(function(d) {
           //        console.log(d.value)
           //
           //          flatSpp.push({
           //            species: d.value.Species,
           //            year: +d.key,
           //            Lutra_lutra: d.value.Lutra_lutra,
           //            Not_identified: d.value.Not_identified,
           //            Unsure: d.value.Unsure,
           //            Multiple: d.value.Multiple,
           //            Aonyx_cinereus: d.value.Aonyx_cinereus,
           //            Lutrogale_perspicillata: d.value.Lutrogale_perspicillata,
           //            Lutra_sumatrana: d.value.Lutra_sumatrana
           //          });
           //
           //      });



           var stack = d3.stack()
               .keys(["Lutra_lutra","Not_identified","Unsure","Multiple","Aonyx_cinereus","Lutrogale_perspicillata","Lutra_sumatrana"])

           var stackUse = d3.stack()
               .keys(["Pet","Tail","Many","Unknown","Carcass","Skin","Piece"]);

           var series = stack(data);
           var seriesUse = stackUse(data);

           console.log(series);

           var arr1 = series[0];

           arr1.filter(function(d){
             return (d[0]!=0) && (d[1]!=0)
           });
           // WHY IS THIS NOT WORKING????



           var xScaleBar = d3.scaleBand().domain(data.map(function(d) {
                   return d.date;
               }))
               .range([margin.left, width - margin.right])
               .padding(0.1);

           var color = d3.scaleOrdinal().domain(["Lutra_lutra","Not_identified","Unsure","Multiple","Aonyx_cinereus","Lutrogale_perspicillata","Lutra_sumatrana"])
           .range(["#008695", "#f97b72","#A5AA99","#CF1C90","#80BA5A","#F2B701","#3969AC"]);

           var colorUse = d3.scaleOrdinal().domain(["Tail","Many","Unknown","Carcass","Skin","Piece","Pet"])
           .range(["#008695", "#f97b72","#A5AA99","#CF1C90","#80BA5A","#F2B701","#3969AC"]);

           // Create groups for each series, rects for each segment
           var groups = svg.selectAll("g.spp")
               .data(series)
               .join("g")
               .attr("class", "spp")
               // .attr("fill",function(d){
               //     var texture = textures
               //         .lines()
               //         .size(4)
               //         .strokeWidth(1.5)
               //         .stroke(color(d.key));
               //         svg.call(texture);
               //      return texture.url();
               // })

           var rect = groups.selectAll("rect")
               .data(d=>d)
               .join("rect")
               .attr("class",d=>`${d.data.Species1} year${d.data.Year}`)
               .attr("y", d =>  yScale(d[1]))
               .attr("x", (d, i) => xScale(d.data.date))
               .attr("width", 15)
               .attr("stroke","black")
               .attr("stroke-width",0.4)
               .attr("fill",function(d){
                   var texture = textures
                       .lines()
                       .size(4)
                       .strokeWidth(1.5)
                       .stroke(color(d.data.Species1));
                       svg.call(texture);
                    return texture.url();
               })
               .attr("id",function(d,i){
                  return d.data.Species1+"_"+i+"_"+d.data.Year
               })
               .attr("height", d => yScale(d[0]) - yScale(d[1]))
               .on('mouseover', function(d){
                   var id = this.id;
                   var year = id.substr(id.length - 4);
                   if(cumulative){
                     $(`*[id$=${year}]`).css("cursor","pointer");
                     $(`*[id$=${year}]`).css("stroke-width",1.2);
                   }
               })
               .on('mouseout', function(d){
                   $(".spp rect").css("stroke-width",0.3);
               })
               .on('click',clicked);


               function updateStackedBar(){
                 if(tab1){ //if species

                   groups = svg.selectAll("g.spp")
                       .data(series)
                       .join("g")
                       .attr("class", "spp")
                       // .attr("fill",function(d){
                       //     var texture = textures
                       //         .lines()
                       //         .size(4)
                       //         .strokeWidth(1.5)
                       //         .stroke(color(d.key));
                       //         svg.call(texture);
                       //      return texture.url();
                       // })

                   rect = groups.selectAll("rect")
                       .data(d=>d)
                       .join("rect")
                       .attr("class",d=>`${d.data.Species1} year${d.data.Year}`)
                       .attr("y", d => yScale(d[1]))
                       .attr("x", (d, i) => xScale(d.data.date))
                       .attr("width", 15)
                       .attr("stroke","black")
                       .attr("stroke-width",0.3)
                       .attr("fill",function(d){
                           var texture = textures
                               .lines()
                               .size(4)
                               .strokeWidth(1.5)
                               .stroke(color(d.data.Species1));
                               svg.call(texture);
                            return texture.url();
                       })
                       .attr("id",function(d,i){
                         return d.data.Species1+"_"+i+"_"+d.data.Year
                       })
                       .attr("height", d => yScale(d[0]) - yScale(d[1]));

                 }else{ //if use

                   groups = svg.selectAll("g.spp").data(seriesUse).join("g").attr("class", "spp")
                   // .attr("fill",function(d){
                   //     var texture = textures
                   //         .lines()
                   //         .size(4)
                   //         .strokeWidth(1.5)
                   //         .stroke(colorUse(d.key));
                   //         svg.call(texture);
                   //      return texture.url();
                   // });

                   rect = groups.selectAll("rect")
                       .data(d=>d)
                       .join("rect")
                       .attr("class",d=>`${d.data.Use} year${d.data.Year}`)
                       .attr("y", d => yScale(d[1]))
                       .attr("x", (d, i) => xScale(d.data.date))
                       .attr("width", 15)
                       .attr("stroke","black")
                       .attr("stroke-width",0.3)
                       .attr("fill",function(d){
                           var texture = textures
                               .lines()
                               .size(4)
                               .strokeWidth(1.5)
                               .stroke(colorUse(d.data.Use));
                               svg.call(texture);
                            return texture.url();
                       })
                       .attr("id",function(d,i){
                         return d.data.Use+"_"+i+"_"+d.data.Year
                       })
                       .attr("height", d => yScale(d[0]) - yScale(d[1]));
                 }
               }


                function clicked(d){
                  //console.log(d3.select(this.parentNode).datum())

                  d3.selectAll(".spp rect").style("stroke-width",0.3);

                  var id = this.id;
                  var year = id.substr(id.length - 4);
                  //console.log(id)

                  if(tab1){

                  d3.selectAll('rect').attr('fill',el=>color(el.data.Species1));

                  d3.selectAll(`.year${year}`).attr('fill', function(el){
                    var texture = textures
                        .lines()
                        .size(4)
                        .strokeWidth(1.5)
                        .stroke(color(el.data.Species1));
                    svg.call(texture);
                    return texture.url()});

                    var yearClicked = d.data.Year;
                    sliderValG = yearClicked
                    d3.select("#slider").property("value", yearClicked);
                    document.getElementById('selectedYear').innerText = yearClicked;
                    // speciesFilter = ["in", ["get", "species"], ["literal", activeSpecies]];
                    yearFilter =  ['==', ['get','year'], yearClicked];
                    map.setFilter('otters', ['all', useFilter, speciesFilter,yearFilter]);

                  }else{

                    d3.selectAll('rect').attr('fill',el=>colorUse(el.data.Use));

                    d3.selectAll(`.year${year}`).attr('fill', function(el){
                      var texture = textures
                          .lines()
                          .size(4)
                          .strokeWidth(1.5)
                          .stroke(colorUse(el.data.Use));
                      svg.call(texture);
                      return texture.url()});

                      var yearClicked = d.data.Year;
                      sliderValG = yearClicked
                      d3.select("#slider").property("value", yearClicked);
                      document.getElementById('selectedYear').innerText = yearClicked;
                      // speciesFilter = ["in", ["get", "species"], ["literal", activeSpecies]];
                      yearFilter =  ['==', ['get','year'], yearClicked];
                      map.setFilter('otters', ['all', useFilter, speciesFilter,yearFilter]);

                  }

                }


               //redraw doesn't work across modes (species vs use)
               function redraw(newdata){


                // update the y scale
                yScale.domain([0,d3.max(newdata, d=>d.Sum)]);
                svg.select(".y-axis")
                  .transition().duration(1000)
                  .call(d3.axisLeft(yScale));

                  groups = d3.selectAll("g.spp")
                      .data(stack(newdata))
                      .join("g")
                      .attr("class", "spp");

               //below have not been updated

               if(tab1){

               rect = groups.selectAll("rect")
                   .data(d=>d)
                   .join('rect')
                   .attr("height", d => yScale(d[0]) - yScale(d[1]))
                   .attr("class",d=>`${d.data.Species1} year${d.data.Year}`)
                   .attr("y", d => yScale(d[1]))
                   .attr("x", (d, i) => xScale(d.data.date))
                   .attr("width", 15)
                   .attr("stroke","black")
                   .attr("stroke-width",0.3)
                   .attr("fill",function(d){
                     if(cumulative){
                          var texture = textures
                              .lines()
                              .size(4)
                              .strokeWidth(1.5)
                              .stroke(color(d.data.Species1));
                          svg.call(texture);
                          if(d.data.Year <= sliderValG){ return texture.url()}
                          else{
                            return color(d.data.Species1)
                          }
                     }else{
                         var texture = textures
                             .lines()
                             .size(4)
                             .strokeWidth(1.5)
                             .stroke(color(d.data.Species1));
                         svg.call(texture);
                         if(d.data.Year == sliderValG){ return texture.url()}
                         else{
                           return color(d.data.Species1)
                         }
                     }
                   })
                   .attr("id",function(d,i){
                     return d.data.Species1+"_"+i+"_"+d.data.Year
                   }).on('mouseover', function(d){
                       var id = this.id;
                       var year = id.substr(id.length - 4);
                       if(cumulative){
                         $(`*[id$=${year}]`).css("cursor","pointer");
                         $(`*[id$=${year}]`).css("stroke-width",1.2);
                       }
                   })
                   .on('mouseout', function(d){
                       $(".spp rect").css("stroke-width",0.3);
                   })
                   .on('click',clicked); //clicked on working

                 }else{

                   rect = groups.selectAll("rect")
                       .data(d=>d)
                       .join('rect')
                       .attr("height", d => yScale(d[0]) - yScale(d[1]))
                       .attr("class",d=>`${d.data.Use} year${d.data.Year}`)
                       .attr("y", d => yScale(d[1]))
                       .attr("x", (d, i) => xScale(d.data.date))
                       .attr("width", 15)
                       .attr("stroke","black")
                       .attr("stroke-width",0.3)
                       .attr("fill",function(d){
                         if(cumulative){
                              var texture = textures
                                  .lines()
                                  .size(4)
                                  .strokeWidth(1.5)
                                  .stroke(colorUse(d.data.Use));
                              svg.call(texture);
                              if(d.data.Year <= sliderValG){ return texture.url()}
                              else{
                                return colorUse(d.data.Use)
                              }
                         }else{
                             var texture = textures
                                 .lines()
                                 .size(4)
                                 .strokeWidth(1.5)
                                 .stroke(colorUse(d.data.Use));
                             svg.call(texture);
                             if(d.data.Year == sliderValG){ return texture.url()}
                             else{
                               return colorUse(d.data.Use)
                             }
                         }
                       })
                       .attr("id",function(d,i){
                         return d.data.Use+"_"+i+"_"+d.data.Year
                       }).on('mouseover', function(d){
                           var id = this.id;
                           var year = id.substr(id.length - 4);
                           if(cumulative){
                             $(`*[id$=${year}]`).css("cursor","pointer");
                             $(`*[id$=${year}]`).css("stroke-width",1.2);
                           }
                       })
                       .on('mouseout', function(d){
                           $(".spp rect").css("stroke-width",0.3);
                       })
                       .on('click',clicked); //clicked on working

                 }


              }


              //******************
              //setup spp profiles
              //*******************

              function openSppProfile(profileid){

                $(profileid).click(function() {
                  var lastChar = parseInt(profileid.substr(profileid.length - 1));
                  var obj = profilesData.filter(d => d.id === lastChar);
                  $("#profileSpp").html(obj[0].species);
                  $("#profileSpp2").html(obj[0].name);
                  $("#profileImg").attr("src",obj[0].img);
                  $("#profileStatus").html(obj[0].status);
                  d3.select("#profile").transition().duration(200).style("display","inherit").style("opacity",1);
                });
              }

              $("#close").click(function() {
                d3.select("#profile").style("display","none").style("opacity",0);
              })

              openSppProfile("#open1");
              openSppProfile("#open2");
              openSppProfile("#open3");
              openSppProfile("#open4");


              //*********************
              //setup spp range maps
              //*********************

              var pathsClose = [`M10.2,10.8c1.7,0,3-1.3,3-3c0,0,0,0,0,0L10.2,10.8C10.2,10.8,10.2,10.8,10.2,10.8z`,
                `M3.8,11.9l1.4-1.4C4.1,9.8,3.1,8.9,2.3,7.8c1.8-2.5,4.8-4,7.9-4c0.5,0,1,0.1,1.6,0.1l1.7-1.7c-1-0.3-2.1-0.5-3.2-0.5
                c-4.1,0-7.9,2.1-9.9,5.5c-0.2,0.3-0.2,0.7,0,1C1.2,9.8,2.4,11,3.8,11.9z`,
                `M20.1,7.3C19.3,6,18.2,4.9,17,4l-1.4,1.4C16.5,6,17.3,6.8,18,7.8c-1.7,2.5-4.6,4-7.8,4c-0.3,0-0.6,0-1-0.1l-1.7,1.7
                  c0.9,0.2,1.8,0.3,2.7,0.3c4.1,0,7.8-2.1,9.9-5.5C20.3,8,20.3,7.6,20.1,7.3z`,
                  `M10.2,4.8c-0.6,0-1,0.4-1,1c0,0.2,0.1,0.4,0.2,0.5l1.5-1.5C10.6,4.8,10.4,4.8,10.2,4.8z`,
                  `M8.2,6.8c-0.6,0-1,0.4-1,1c0,0.2,0,0.4,0.1,0.6l1.5-1.5C8.6,6.9,8.4,6.8,8.2,6.8z`];

              var pathClose = `M3.8,15.7c-0.3,0-0.6-0.1-0.8-0.3c-0.2-0.2-0.4-0.5-0.3-0.9c0-0.3,0.1-0.6,0.4-0.8l13-13c0.2-0.2,0.5-0.3,0.8-0.3
                s0.6,0.1,0.8,0.3c0.5,0.5,0.5,1.2,0,1.7l-13,13C4.4,15.6,4.1,15.7,3.8,15.7z`;

              var pathOpen = `M0.3,7.3c2-3.4,5.8-5.5,9.9-5.5s7.8,2.1,9.9,5.5c0.2,0.3,0.2,0.7,0,1c-2.1,3.4-5.8,5.5-9.9,5.5s-7.9-2.1-9.9-5.5
                  C0.1,8,0.1,7.6,0.3,7.3z M10.2,11.8c3.2,0,6.1-1.5,7.8-4c-1.8-2.5-4.7-4-7.8-4s-6.1,1.5-7.9,4C4.1,10.3,7,11.8,10.2,11.8z M7.2,7.8
                  c0-0.6,0.4-1,1-1c0.6,0,1,0.4,1,1s0.4,1,1,1s1-0.4,1-1s-0.4-1-1-1s-1-0.4-1-1s0.4-1,1-1c1.7,0,3,1.3,3,3s-1.3,3-3,3S7.2,9.5,7.2,7.8
                  z`;

                  var aonyx = false;
                  var lutra = false;
                  var lutra2 = false;
                  var lutrogale = false;

                  function addRangeToggle(pathId, layer1,layer2,idcount,onOff){

                    var pathCloseG = d3.select(pathId).append("g");

                    d3.select(`svg${pathId}`).append("path").attr("id",`single${idcount}`).attr("d",pathClose)
                    pathCloseG.selectAll(`path.grouped${idcount}`).data(pathsClose).join("path").attr("class",`grouped${idcount}`).attr("d",d=>d);

                    $(pathId).click(function() {
                      if(onOff){
                        onOff = false;
                        map.setPaintProperty(layer1,'line-opacity',0);
                        map.setPaintProperty(layer2,'fill-opacity',0);
                        //d3.select("#add1 path").remove();
                        pathCloseG.selectAll(`path.grouped${idcount}`).data(pathsClose).join("path").attr("class",`grouped${idcount}`).attr("d",d=>d);
                        d3.select(`${pathId} path#single${idcount}`).join().transition().duration(300).attr("d",pathClose);


                      }else{
                        onOff=true;
                        map.setPaintProperty(layer1,'line-opacity',0.7);
                        map.setPaintProperty(layer2,'fill-opacity',0.3);
                        pathCloseG.selectAll(`path.grouped${idcount}`).remove();
                        d3.select(`${pathId} path#single${idcount}`).join().transition().duration(300).attr("d",pathOpen);

                      }
                    });
                  }

                  addRangeToggle('#add1','aonyx','aonyx2',1,aonyx);
                  addRangeToggle('#add2','lutra','lutra2',2,lutra);
                  addRangeToggle('#add3','lutra3','lutra4',3,lutra2);
                  addRangeToggle('#add4','lutrogale','lutrogale2',4,lutrogale);





           function createFilterSpecies(filterName,layerOnName,speciesString){
             document.getElementById(filterName).addEventListener('change', function(e) {
                // update the map filter
                if (e.target.value === layerOnName) {
                  //if layer doesn't exist then push

                  if(activeSpecies.indexOf(speciesString) == -1){

                    activeSpecies.push(speciesString)
                  }

                  var newdata = data.filter(function (d) {
                        // d.Speices not in array
                        return activeSpecies.indexOf(d.Species) > -1 && activeUse.indexOf(d.Use) > -1;
                  });

                  redraw(newdata)

                  speciesFilter = ["in", ["get", "species"], ["literal", activeSpecies]];
                  useFilter = ["in", ["get", "use"], ["literal", activeUse]];
                  if(cumulative){
                     yearFilter =  ['<=', ['get','year'], sliderValG];
                  }else{
                    yearFilter = ["==", ["get", "year"], sliderValG];
                  }

                  // map.setFilter('plants', ['all', speciesFilter,useFilter,yearFilter]);
                  map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);

                } else { //if turn layer off

                  //if layer exists then remove it
                  if(activeSpecies.indexOf(speciesString) !== -1){
                    var index = activeSpecies.indexOf(speciesString);
                        activeSpecies.splice(index, 1);
                  }

                //filter out all data where the d.Species isn't in the activeSpecies array

                var newdata = data.filter(function (d) {
                      // d.Speices not in array
                      return activeSpecies.indexOf(d.Species) > -1 && activeUse.indexOf(d.Use) > -1;
                });
                //console.log(newdata2)

                redraw(newdata);

                speciesFilter = ["in", ["get", "species"], ["literal", activeSpecies]];
                useFilter = ["in", ["get", "use"], ["literal", activeUse]];
                if(cumulative){
                   yearFilter =  ['<=', ['get','year'], sliderValG];
                }else{
                  yearFilter = ["==", ["get", "year"], sliderValG];
                }
                map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);

                }
            });

           }

           createFilterSpecies('filter1','Aonyx_cinereus_on','Aonyx cinereus')
           createFilterSpecies('filter2','Lutra_lutra_on','Lutra lutra')
           createFilterSpecies('filter3','Lutra_sumatrana_on','Lutra sumatrana')
           createFilterSpecies('filter4','Lutrogale_perspicillata_on','Lutrogale perspicillata')
           createFilterSpecies('filter5','Multiple_on','Multiple')
           createFilterSpecies('filter6','Unsure_on','Unsure')
           createFilterSpecies('filter7','Not_identified_on','Not identified')

         function createFilterUse(filterName,layerOnName,useString){
          document.getElementById(filterName).addEventListener('change', function(e) {
            // update the map filter
            if (e.target.value === layerOnName) {
              //if layer doesn't exist then push

              if(activeUse.indexOf(useString) == -1){
                activeUse.push(useString)
              }

              var newdata = data.filter(function (d) {
                    return activeSpecies.indexOf(d.Species) > -1 && activeUse.indexOf(d.Use) > -1;
              });

              redraw(newdata)

              useFilter = ["in", ["get", "use"], ["literal", activeUse]];

              if(cumulative){
                 yearFilter =  ['<=', ['get','year'], sliderValG];
              }else{
                yearFilter = ["==", ["get", "year"], sliderValG];
              }

              // map.setFilter('plants', ['all', speciesFilter,useFilter,yearFilter]);
              map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);

            } else { //if turn layer off

              //if layer exists then remove it
              if(activeUse.indexOf(useString) !== -1){
                var index = activeUse.indexOf(useString);
                    activeUse.splice(index, 1);
              }

            var newdata = data.filter(function (d) {
                  return activeSpecies.indexOf(d.Species) > -1 && activeUse.indexOf(d.Use) > -1;
            });

            redraw(newdata);

            useFilter = ["in", ["get", "use"], ["literal", activeUse]];
            if(cumulative){
               yearFilter =  ['<=', ['get','year'], sliderValG];
            }else{
              yearFilter = ["==", ["get", "year"], sliderValG];
            }
            map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);

            }

         });
       }

       createFilterUse('filter8','Skin_on','Skin')
       createFilterUse('filter9','Tail_on','Tail')
       createFilterUse('filter10','Pet_on','Pet')
       createFilterUse('filter11','Piece_on','Piece')
       createFilterUse('filter12','Carcass_on','Carcass')
       createFilterUse('filter13','Unknown_on','Unknown')
       createFilterUse('filter14','Multiple2_on','Many')

       // map.on('closeAllPopups', () => {
       //   popup.remove();
       // });



       $("#reset2").click(function() {

         for(var i=0; i<allSpecies.length;i++){
           if(activeSpecies.indexOf(allSpecies[i]) == -1){
             activeSpecies.push(allSpecies[i]);
           }
         }

         var newdata = data.filter(function (d) {
               // d.Speices not in array
               return activeSpecies.indexOf(d.Species) > -1;
         });

         redraw(newdata)

         speciesFilter = ["in", ["get", "species"], ["literal", activeSpecies]];
         // useFilter = ["in", ["get", "use"], ["literal", activeUse]];
         // yearFilter =  ['<=', ['get','year'], sliderValG];
         map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);

         $("#Aonyx_cinereus_on").prop('checked', true);
         $("#Aonyx_cinereus_off").prop('checked', false);
         $("#Lutra_lutra_on").prop('checked', true);
         $("#Lutra_lutra_off").prop('checked', false);
         $("#Lutra_sumatrana_on").prop('checked', true);
         $("#Lutra_sumatrana_off").prop('checked', false);
         $("#Lutrogale_perspicillata_on").prop('checked', true);
         $("#Lutrogale_perspicillata_off").prop('checked', false);
         $("#Multiple_on").prop('checked', true);
         $("#Multiple_off").prop('checked', false);
         $("#Unsure_on").prop('checked', true);
         $("#Unsure_off").prop('checked', false);
         $("#Not_identified_on").prop('checked', true);
         $("#Not_identified_off").prop('checked', false);

       });
       //
       //
       // $("#reset2").click(function() {
       //
       //   for(var i=0; i<allFuels.length;i++){
       //     if(activeUse.indexOf(allFuels[i]) == -1){
       //       activeUse.push(allFuels[i]);
       //     }
       //   }
       //   speciesFilter = ["in", ["get", "status"], ["literal", activeSpecies]];
       //   useFilter = ["in", ["get", "mainFuel"], ["literal", activeUse]];
       //   yearFilter =  ['>=', ['get','capacity'], sliderValG];
       //   // yearFilter =  ['>=', ['get','capacity'], 1];
       //   map.setFilter('plants', ['all', speciesFilter,useFilter,yearFilter]);
       //   // $("#slider").val(1);
       //   // $("#slider").trigger('change');
       //   $("#Tail_on").prop('checked', true);
       //   $("#layer9ff").prop('checked', false);
       //   $("#Pet_on").prop('checked', true);
       //   $("#layer10ff").prop('checked', false);
       //   $("#Piece_on").prop('checked', true);
       //   $("#Piece_off").prop('checked', false);
       //   $("#Carcass_on").prop('checked', true);
       //   $("#Carcass_off").prop('checked', false);
       //   $("#Unknown_on").prop('checked', true);
       //   $("#Unknown_off").prop('checked', false);
       //   $("#Multiple2_on").prop('checked', true);
       //   $("#Multiple2_off").prop('checked', false);
       //   $("#layer15On").prop('checked', true);
       //   $("#layer15Off").prop('checked', false);
       //   $("#layer16On").prop('checked', true);
       //   $("#layer16Off").prop('checked', false);
       //
       // });
       //
       //

       // not working properly if I click on a year, deselct a spp then click on reset... it's still stuck on the year selected instead of 2019
       $("#reset3").click(function() {

         $("#cumulative_on").prop('checked', true);
         $("#cumulative_off").prop('checked', false);

         d3.selectAll('rect').attr('fill',function(el){
           var texture = textures
               .lines()
               .size(4)
               .strokeWidth(1.5)
               .stroke(color(el.data.Species1));
           svg.call(texture);
           return texture.url()});
         //reset all rect colors

         speciesFilter = ["in", ["get", "species"], ["literal", activeSpecies]];
         // useFilter = ["in", ["get", "mainFuel"], ["literal", activeUse]];
         yearFilter =  ['<=', ['get','year'], 2019];
         document.getElementById('selectedYear').innerText = 2019;
         $("#slider").val(2019);
         $("#slider").trigger('change');
         sliderValG = 2019;
         map.setFilter('otters', ['all', speciesFilter,useFilter,yearFilter]);

       });


       //barFilter

       // d3.selectAll("g.spp rect").on("click", d=> barClicked(d))
       //
       // function barClicked(d){
       //
       //   console.log(d)
       //
       //   var speciesClicked = d.data.Species.replaceAll("_"," ")
       //   var yearClicked = d.data.Year;
       //
       //     speciesFilter = ["==", ["get", "species"], ["literal", speciesClicked]];
       //     yearFilter =  ['==', ['get','year'], yearClicked];
       //     map.setFilter('otters', ['all', speciesFilter,yearFilter]);
       // }



          $("document").ready(function(){
              $(".tab-slider--body").hide();
              $(".tab-slider--body:first").show();
            });

            $(".tab-slider--nav li").click(function() {
              $(".tab-slider--body").hide();
              // map.fire('closeAllPopups');
              $('.mapboxgl-popup').remove();

              // var activeTab = $(this).attr("rel");
              var activeTab;

              tab1 = !tab1;

              if(tab1){
                activeTab = "tab1"
              }else{
                activeTab = "tab2"
              }

              if(tab1){

                updateStackedBar();

                var newdata = data.filter(function (d) {
                      // d.Speices not in array
                      return activeSpecies.indexOf(d.Species) > -1 && activeUse.indexOf(d.Use) > -1;
                });

                redraw(newdata)

                $("#toggleConsole").css("top", 330);
                if(medium){
                  $("#toggleConsole").css("top", 260);
                }

                if(mobile){
                  $("#toggleConsole").css("top", 260);
                }

                map.setPaintProperty('otters',"circle-color", [
                     "case",
                     ["==", ["get", "species"], 'Aonyx cinereus'],
                     "#80BA5A",
                     ["==", ["get", "species"], 'Lutra lutra'],
                     "#008695",
                     ["==", ["get", "species"], 'Lutra sumatrana'],
                     '#3969AC',
                     ["==", ["get", "species"], 'Lutrogale perspicillata'],
                      '#F2B701',
                     ["==", ["get", "species"], 'Multiple'],
                      '#CF1C90',
                     ["==", ["get", "species"], 'Unsure'],
                     "#A5AA99",
                     "#f97b72"
                   ])


              }else{

                updateStackedBar();

                var newdata = data.filter(function (d) {
                      // d.Speices not in array
                      return activeSpecies.indexOf(d.Species) > -1 && activeUse.indexOf(d.Use) > -1;
                });

                redraw(newdata)

                $("#toggleConsole").css("top", 310);
                if(medium){
                  $("#toggleConsole").css("top", 250);
                }

                if(mobile){
                  $("#toggleConsole").css("top", 240);
                }


                  map.setPaintProperty('otters',"circle-color", [
                    "case",
                    ["==", ["get", "use"], 'Skin'],
                    "#80BA5A",
                    ["==", ["get", "use"], 'Tail'],
                    "#008695",
                    ["==", ["get", "use"], 'Pet'],
                    '#3969AC',
                    ["==", ["get", "use"], 'Piece'],
                     '#F2B701',
                    ["==", ["get", "use"], 'Carcass'],
                     '#CF1C90',
                    ["==", ["get", "use"], 'Unknown'],
                    "#A5AA99",
                    "#f97b72"
                     ])



              }

              $("#"+activeTab).fadeIn();
              if(!tab1){
                $('.tab-slider--tabs').addClass('slide');
              }else{
                $('.tab-slider--tabs').removeClass('slide');
              }
              $(".tab-slider--nav li").removeClass("activeTab");
              $('[rel="'+activeTab+'"]').addClass("activeTab");
            });




          // map.on('mouseleave', function() {
          //     map.getCanvas().style.cursor = '';
          //     // popup.270();
          // });
          //
          // // $(".tab-slider--nav li").click(function() {
          // //   popup.remove();
          // // });
          //
          //
            map.on('click', 'otters', function(e) {

              console.log(e)
                map.getCanvas().style.cursor = 'pointer';

                var latitude = e.features[0].properties.latitude;
                var longitude = e.features[0].properties.longitude;
                var year = e.features[0].properties.year;
                var country = e.features[0].properties.country;
                var location = e.features[0].properties.location;
                var sum = e.features[0].properties.sum;
                var species = e.features[0].properties.species;
                var speciesDetail = e.features[0].properties.speciesDetail;
                var use = e.features[0].properties.use;
                var useDetail = e.features[0].properties.useDetail;


                while (Math.abs(e.lngLat.lng - latitude) > 180) {
                    latitude += e.lngLat.lng > latitude ? 360 : -360;
                }

                var popupClass="color1";
                var color = "#80BA5A";


                // if(tab1){
                //   if(mainFuel== 'Gas natural'){
                //     color = "#80BA5A";
                //     popupClass="color1"
                //   }else if(mainFuel== 'Gas propano'){
                //     color = "#A5AA99";
                //     popupClass="color6"
                //   }else if(mainFuel== 'Carbón'){
                //     color = "#008695";
                //     popupClass="color2"
                //   }else if(mainFuel== 'Petróleo'){
                //     color = "#CF1C90";
                //     popupClass="color5"
                //   }else if(mainFuel== 'Fuel oil'){
                //     color = "#3969AC";
                //     popupClass="color3"
                //   }else if(mainFuel== 'Diesel'){
                //     color = "#F2B701";
                //     popupClass="color4"
                //   }else if(mainFuel== 'Coque de petróleo'){
                //     color = "#f97b72";
                //     popupClass="color7"
                //   }else{
                //     color = "#7F3C8D";
                //     popupClass="color8"
                //   }
                // }else{
                //   if(status== 'Activa'){
                //     color = "#80BA5A";
                //     popupClass="color1"
                //   }else if(status== 'Cerrada'){
                //     color = "#008695";
                //     popupClass="color2"
                //   }else if(status== 'Planeada'){
                //     color = "#3969AC";
                //     popupClass="color3"
                //   }else if(status== 'Descartada'){
                //     color = "#F2B701";
                //     popupClass="color4"
                //   }else if(status== 'En construcción'){
                //     color = "#CF1C90";
                //     popupClass="color5"
                //   }else if(status== 'Paralizada'){
                //     color = "#A5AA99";
                //     popupClass="color6"
                //   }else{
                //     color = "#f97b72";
                //     popupClass="color7"
                //   }
                // }

                  popup = new mapboxgl.Popup({
                          closeButton: true,
                          closeOnClick: true,
                          className: popupClass
                      })
                      .setHTML('<h3 class="popupClass"><b>' + location + ', '+country + '</b></h3>'
                      + '<h4><b>Year</b>: '+year+'<br>'
                      + '<b>Number of otters</b>: '+sum+'<br>'
                      + '<b>Species</b>: '+speciesDetail+'<br>'
                      + '<b>Use</b>: '+use+'</h4>')
                      .setLngLat([longitude, latitude])
                      .addTo(map);



                    $(`.button.${popupClass}`).hover(function(){
                      $(".button a").css("color","white");
                      $(this).css("background-color",color);
                     },function(){
                       $(".button a").css("color",color);
                       $(this).css("background-color","white");
                     });
                     $(".mapboxgl-popup-tip").css("border-bottom-color",color);

                $(".mapboxgl-popup-tip").css("border-bottom-color", color);

            });

            //mobile

            // map.on('touchstart', 'plants', function(e) {
            //
            //   map.getCanvas().style.cursor = 'pointer';
            //
            //   var latitude = e.features[0].properties.latitude;
            //   var longitude = e.features[0].properties.longitude;
            //   var country = e.features[0].properties.country;
            //   var project = e.features[0].properties.project;
            //   var mainFuel = e.features[0].properties.mainFuel;
            //   var otherFuels = e.features[0].properties.otherFuels;
            //   var location = e.features[0].properties.location;
            //   var status = e.features[0].properties.status;
            //   var capacity = e.features[0].properties.capacity;
            //   var operationStart = e.features[0].properties.operationStart;
            //   var owner = e.features[0].properties.owner;
            //   var capital = e.features[0].properties.capital;
            //   var companyHQ = e.features[0].properties.companyHQ;
            //   var shareholders = e.features[0].properties.shareholders;
            //   var notes = e.features[0].properties.notes;
            //   var links = e.features[0].properties.links;
            //
            //
            //   while (Math.abs(e.lngLat.lng - latitude) > 180) {
            //       latitude += e.lngLat.lng > latitude ? 360 : -360;
            //   }
            //
            //   var popupClass="color1";
            //   var color = "#80BA5A";
            //
            //
            //   if(tab1){
            //     if(mainFuel== 'Gas natural'){
            //       color = "#80BA5A";
            //       popupClass="color1"
            //     }else if(mainFuel== 'Gas propano'){
            //       color = "#A5AA99";
            //       popupClass="color6"
            //     }else if(mainFuel== 'Carbón'){
            //       color = "#008695";
            //       popupClass="color2"
            //     }else if(mainFuel== 'Petróleo'){
            //       color = "#CF1C90";
            //       popupClass="color5"
            //     }else if(mainFuel== 'Fuel oil'){
            //       color = "#3969AC";
            //       popupClass="color3"
            //     }else if(mainFuel== 'Diesel'){
            //       color = "#F2B701";
            //       popupClass="color4"
            //     }else if(mainFuel== 'Coque de petróleo'){
            //       color = "#f97b72";
            //       popupClass="color7"
            //     }else{
            //       color = "#7F3C8D";
            //       popupClass="color8"
            //     }
            //   }else{
            //     if(status== 'Activa'){
            //       color = "#80BA5A";
            //       popupClass="color1"
            //     }else if(status== 'Cerrada'){
            //       color = "#008695";
            //       popupClass="color2"
            //     }else if(status== 'Planeada'){
            //       color = "#3969AC";
            //       popupClass="color3"
            //     }else if(status== 'Descartada'){
            //       color = "#F2B701";
            //       popupClass="color4"
            //     }else if(status== 'En construcción'){
            //       color = "#CF1C90";
            //       popupClass="color5"
            //     }else if(status== 'Paralizada'){
            //       color = "#A5AA99";
            //       popupClass="color6"
            //     }else{
            //       color = "#f97b72";
            //       popupClass="color7"
            //     }
            //   }
            //
            //   if(links == "" || links == null){
            //     popup = new mapboxgl.Popup({
            //             closeButton: true,
            //             closeOnClick: true,
            //             className: popupClass
            //         })
            //         .setHTML('<h3 class="popupClass"><b>' + project + '</b></h3>'
            //         + '<h4><b>País</b>: '+country+'<br>'
            //         + '<b>Ubicación</b>: '+location+'<br>'
            //         + '<b>Estatus</b>: '+status+'<br>'
            //         + '<b>Capacidad</b>: '+capacity+' MW<br>'
            //         + '<b>Combustible principal</b>: '+mainFuel+'<br>'
            //         + '<b>Otros combustibles</b>: '+otherFuels+'<br>'
            //         + '<b>Inicio operaciones</b>: '+operationStart+'<br>'
            //         + '<b>Propietario/ Operador</b>: '+owner+'<br>'
            //         + '<b>Sede empresa</b>: '+companyHQ+'<br>'
            //         + '<b>Capital</b>: '+capital+'<br>'
            //         + '<b>Accionistas</b>: '+shareholders+'</h4>')
            //         .setLngLat([longitude, latitude])
            //         .addTo(map);
            //
            //   }else{
            //     popup = new mapboxgl.Popup({
            //             closeButton: true,
            //             closeOnClick: true,
            //             className: popupClass
            //         })
            //         .setHTML('<h3 class="popupClass"><b>' + project + '</b></h3>'
            //         + '<h4><b>País</b>: '+country+'<br>'
            //         + '<b>Ubicación</b>: '+location+'<br>'
            //         + '<b>Estatus</b>: '+status+'<br>'
            //         + '<b>Capacidad</b>: '+capacity+' MW<br>'
            //         + '<b>Combustible principal</b>: '+mainFuel+'<br>'
            //         + '<b>Otros combustibles</b>: '+otherFuels+'<br>'
            //         + '<b>Inicio operaciones</b>: '+operationStart+'<br>'
            //         + '<b>Propietario/ Operador</b>: '+owner+'<br>'
            //         + '<b>Sede empresa</b>: '+companyHQ+'<br>'
            //         + '<b>Capital</b>: '+capital+'<br>'
            //         + '<b>Accionistas</b>: '+shareholders+'</h4>'
            //         + `<div class="button ${popupClass}"><a target="_blank" href="${links}">LEER MÁS</a></div>`)
            //         .setLngLat([longitude, latitude])
            //         .addTo(map);
            //   }
            //
            //
            //       $(`.button.${popupClass}`).hover(function(){
            //         $(".button a").css("color","white");
            //         $(this).css("background-color",color);
            //        },function(){
            //          $(".button a").css("color",color);
            //          $(this).css("background-color","white");
            //        });
            //        $(".mapboxgl-popup-tip").css("border-bottom-color",color);
            //
            //   $(".mapboxgl-popup-tip").css("border-bottom-color",color);
            //
            //
            // });


      }
       </script>
    </body>
    <div id="loading">
       <img id="loading-image" src="./img/load.gif" alt="Loading..." />
    </div>
 </html>
